name: Sonar, Build and Push Docker Images

on:
  push:
    branches: [ "master", "int", "dev" ]
  pull_request:
    branches: [ "master", "int", "dev" ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ðŸ§® Obtener nombre de rama actual
      - name: ðŸ§® Determine branch
        id: vars
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Current branch: $BRANCH_NAME"

      # ðŸ” Login a DockerHub
      - name: ðŸ” Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      # ðŸ§© Ejecutar flujo completo para cada servicio (independiente)
      - name: ðŸš€ Run full pipeline per service
        id: build
        run: |
          SERVICES=(
            auth-service
            config-service
            discovery-service
            gateway-service
            catalog-service
            customer-service
            inventory-service
            notification-service
            rental-service
          )

          mkdir -p reports
          SUCCESS_LIST=""
          FAIL_LIST=""

          for SERVICE in "${SERVICES[@]}"; do
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ðŸ”§ Processing service: $SERVICE"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            cd $SERVICE || { echo "âŒ ERROR: No se encontrÃ³ el directorio $SERVICE"; FAIL_LIST+="$SERVICE "; cd ..; continue; }

            # Extraer versiÃ³n del pom.xml
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            echo "ðŸ“¦ Version detected: $VERSION"

            # AnÃ¡lisis SonarQube
            echo "ðŸ” Running SonarQube analysis for $SERVICE..."
            if ! mvn sonar:sonar \
              -DskipTests=true \
              -Dsonar.projectKey=$SERVICE \
              -Dsonar.projectName=$SERVICE \
              -Dsonar.host.url=$SONAR_HOST_URL \
              -Dsonar.login=$SONAR_TOKEN; then
              echo "âš ï¸ SonarQube analysis failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(Sonar) "
              cd ..
              continue
            fi

            # Quality Gate Check
            echo "ðŸš¦ Waiting for Quality Gate result..."
            if ! docker run --rm \
                -v "$(pwd)/target:/usr/src" \
                sonarsource/sonar-scanner-cli \
                sonar-quality-gate \
                -Dsonar.projectKey=$SERVICE \
                -Dsonar.host.url=$SONAR_HOST_URL \
                -Dsonar.login=$SONAR_TOKEN; then
              echo "âŒ Quality Gate failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(QualityGate) "
              cd ..
              continue
            fi

            # CompilaciÃ³n Maven
            echo "âš™ï¸ Building $SERVICE..."
            if ! mvn clean package -DskipTests; then
              echo "âŒ Build failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(Build) "
              cd ..
              continue
            fi

            # ConstrucciÃ³n y Push Docker
            echo "ðŸ³ Building and pushing Docker image..."
            IMAGE=javierlobo/$SERVICE
            TAG_BRANCH=${{ steps.vars.outputs.branch }}
            docker build -t $IMAGE:$VERSION .
            docker tag $IMAGE:$VERSION $IMAGE:$TAG_BRANCH-$VERSION
            docker tag $IMAGE:$VERSION $IMAGE:latest

            if docker push $IMAGE:$VERSION && \
               docker push $IMAGE:$TAG_BRANCH-$VERSION && \
               docker push $IMAGE:latest; then
              SUCCESS_LIST+="$SERVICE "
              echo "âœ… Service $SERVICE built and pushed successfully"
            else
              FAIL_LIST+="$SERVICE(Docker) "
              echo "âŒ Docker push failed for $SERVICE" | tee -a ../reports/$SERVICE.log
            fi

            cd ..
          done

          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸ“‹ SUMMARY REPORT"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… Successful services: $SUCCESS_LIST"
          echo "âŒ Failed services: $FAIL_LIST"

          echo "success=$SUCCESS_LIST" >> $GITHUB_OUTPUT
          echo "fail=$FAIL_LIST" >> $GITHUB_OUTPUT
