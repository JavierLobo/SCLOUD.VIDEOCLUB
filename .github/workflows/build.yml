name: SonarCloud, Build and Push Docker Images

on:
  push:
    branches: [ "master", "int", "dev" ]
  pull_request:
    branches: [ "master", "int", "dev" ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 🧮 Determine branch
        id: vars
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "📦 Current branch: $BRANCH_NAME"

      - name: 🔐 Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 🚀 Run full CI/CD pipeline per service
        id: build
        run: |
          SERVICES=(
            auth-service
            config-service
            discovery-service
            gateway-service
            catalog-service
            customer-service
            inventory-service
            notification-service
            rental-service
          )

          SUCCESS_LIST=""
          FAIL_LIST=""
          mkdir -p reports

          for SERVICE in "${SERVICES[@]}"; do
            echo "──────────────────────────────────────────────"
            echo "🔧 Processing service: $SERVICE"
            echo "──────────────────────────────────────────────"
            cd $SERVICE || { echo "❌ ERROR: $SERVICE directory not found"; FAIL_LIST+="$SERVICE "; cd ..; continue; }

            # Obtener versión desde el pom.xml
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            echo "📦 Version detected: $VERSION"

            # 🔍 Paso 1: Análisis en SonarCloud
            echo "🔎 Running SonarCloud analysis for $SERVICE ..."
            if ! mvn verify sonar:sonar \
              -DskipTests=true \
              -Dsonar.projectKey=${{ secrets.SONAR_ORGANIZATION }}_${SERVICE} \
              -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
              -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
              -Dsonar.login=${{ secrets.SONAR_TOKEN }}; then
              echo "⚠️ SonarCloud analysis failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(Sonar) "
              cd ..
              continue
            fi

            # ⚙️ Paso 2: Compilar con Maven
            echo "⚙️ Building $SERVICE ..."
            if ! mvn clean package -DskipTests; then
              echo "❌ Build failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(Build) "
              cd ..
              continue
            fi

            # 🐳 Paso 3: Build y Push Docker
            IMAGE=javierlobo/$SERVICE
            TAG_BRANCH=${{ steps.vars.outputs.branch }}

            echo "🐳 Building Docker image for $SERVICE ..."
            docker build -t $IMAGE:$VERSION .

            docker tag $IMAGE:$VERSION $IMAGE:$TAG_BRANCH-$VERSION
            docker tag $IMAGE:$VERSION $IMAGE:latest

            echo "📤 Pushing Docker images for $SERVICE ..."
            if docker push $IMAGE:$VERSION && \
               docker push $IMAGE:$TAG_BRANCH-$VERSION && \
               docker push $IMAGE:latest; then
              echo "✅ $SERVICE pushed successfully"
              SUCCESS_LIST+="$SERVICE "
            else
              echo "❌ Docker push failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(Docker) "
            fi

            cd ..
          done

          echo ""
          echo "──────────────────────────────────────────────"
          echo "📋 SUMMARY REPORT"
          echo "──────────────────────────────────────────────"
          echo "✅ Successful services: $SUCCESS_LIST"
          echo "❌ Failed services: $FAIL_LIST"
          echo "──────────────────────────────────────────────"
