name: SonarCloud, Build and Push Docker Images

on:
  push:
    branches: [ "master", "int", "dev" ]
  pull_request:
    branches: [ "master", "int", "dev" ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ§® Determine branch
        id: vars
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Current branch: $BRANCH_NAME"

      - name: ğŸ” Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸš€ Run full CI/CD pipeline per service
        id: build
        run: |
          SERVICES=(
            auth-service
            config-service
            discovery-service
            gateway-service
            catalog-service
            customer-service
            inventory-service
            notification-service
            rental-service
          )

          SUCCESS_LIST=""
          FAIL_LIST=""
          mkdir -p reports

          for SERVICE in "${SERVICES[@]}"; do
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ğŸ”§ Processing service: $SERVICE"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            cd $SERVICE || { echo "âŒ ERROR: $SERVICE directory not found"; FAIL_LIST+="$SERVICE "; cd ..; continue; }

            # Obtener versiÃ³n desde el pom.xml
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            echo "ğŸ“¦ Version detected: $VERSION"

            # ğŸ” Paso 1: AnÃ¡lisis en SonarCloud
            echo "ğŸ” Running SonarCloud analysis for $SERVICE ..."
            if ! mvn verify sonar:sonar \
              -DskipTests=true \
              -Dsonar.projectKey=${{ secrets.SONAR_ORGANIZATION }}_${SERVICE} \
              -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
              -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
              -Dsonar.login=${{ secrets.SONAR_TOKEN }}; then
              echo "âš ï¸ SonarCloud analysis failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(Sonar) "
              cd ..
              continue
            fi

            # âš™ï¸ Paso 2: Compilar con Maven
            echo "âš™ï¸ Building $SERVICE ..."
            if ! mvn clean package -DskipTests; then
              echo "âŒ Build failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(Build) "
              cd ..
              continue
            fi

            # ğŸ³ Paso 3: Build y Push Docker
            IMAGE=javierlobo/$SERVICE
            TAG_BRANCH=${{ steps.vars.outputs.branch }}

            echo "ğŸ³ Building Docker image for $SERVICE ..."
            docker build -t $IMAGE:$VERSION .

            docker tag $IMAGE:$VERSION $IMAGE:$TAG_BRANCH-$VERSION
            docker tag $IMAGE:$VERSION $IMAGE:latest

            echo "ğŸ“¤ Pushing Docker images for $SERVICE ..."
            if docker push $IMAGE:$VERSION && \
               docker push $IMAGE:$TAG_BRANCH-$VERSION && \
               docker push $IMAGE:latest; then
              echo "âœ… $SERVICE pushed successfully"
              SUCCESS_LIST+="$SERVICE "
            else
              echo "âŒ Docker push failed for $SERVICE" | tee -a ../reports/$SERVICE.log
              FAIL_LIST+="$SERVICE(Docker) "
            fi

            cd ..
          done

          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“‹ SUMMARY REPORT"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… Successful services: $SUCCESS_LIST"
          echo "âŒ Failed services: $FAIL_LIST"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
